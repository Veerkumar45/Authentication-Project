<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Django Cookie Auth Demo</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    input, button { padding: 8px; margin: 5px 0; width: 250px; }
    button { cursor: pointer; }
    fieldset { margin: 15px 0; padding: 15px; }
    #output { background: #111; color: #eee; padding: 12px; min-height: 120px; white-space: pre-wrap; }
  </style>
</head>
<body>
  <h2>üîê Django Authentication Flow (Frontend Test)</h2>

  <fieldset>
    <legend>1. Get CSRF Token</legend>
    <button onclick="getCsrf()">Fetch CSRF</button>
    <span id="csrfToken"></span>
  </fieldset>

  <fieldset>
    <legend>2. Register</legend>
    <input id="regEmail" type="email" placeholder="Email"><br>
    <input id="regPassword" type="password" placeholder="Password"><br>
    <button onclick="register()">Register (send OTP)</button><br>
    <input id="regOtp" type="text" placeholder="Enter OTP"><br>
    <button onclick="verify()">Verify OTP</button>
  </fieldset>

  <fieldset>
    <legend>3. Login</legend>
    <input id="loginEmail" type="email" placeholder="Email"><br>
    <input id="loginPassword" type="password" placeholder="Password"><br>
    <button onclick="login()">Login</button>
  </fieldset>

  <fieldset>
    <legend>4. Protected</legend>
    <button onclick="getMe()">Get /me</button>
    <button onclick="logout()">Logout</button>
  </fieldset>

  <h3>üìú Output</h3>
  <div id="output"></div>

<script>
  let CSRF_TOKEN = "";

  function log(message) {
    document.getElementById("output").textContent += message + "\n";
  }

  async function getCsrf() {
    const res = await fetch("/api/csrf/", { credentials: "include" });
    const data = await res.json();
    CSRF_TOKEN = data.csrfToken;
    document.getElementById("csrfToken").innerText = "CSRF: " + CSRF_TOKEN;
    log("CSRF fetched: " + CSRF_TOKEN);
  }

  async function postJson(url, body={}) {
    if (!CSRF_TOKEN) { log("‚ùå No CSRF token. Click Get CSRF first."); return; }
    const res = await fetch(url, {
      method: "POST",
      credentials: "include",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": CSRF_TOKEN
      },
      body: JSON.stringify(body)
    });
    const data = await res.json();
    log(url + " ‚Üí " + JSON.stringify(data));
    return data;
  }

  async function register() {
    const email = document.getElementById("regEmail").value;
    const password = document.getElementById("regPassword").value;
    await postJson("/api/register/", { email, password });
    log("üì© Check server console for OTP (since console email backend).");
  }

  async function verify() {
    const email = document.getElementById("regEmail").value;
    const otp = document.getElementById("regOtp").value;
    await postJson("/api/register/verify/", { email, otp });
  }

  async function login() {
    const email = document.getElementById("loginEmail").value;
    const password = document.getElementById("loginPassword").value;
    await postJson("/api/login/", { email, password });
  }

  async function getMe() {
    const res = await fetch("/api/me/", { credentials: "include" });
    const data = await res.json();
    log("/api/me ‚Üí " + JSON.stringify(data));
  }

  async function logout() {
    await postJson("/api/logout/", {});
  }

  // auto-fetch CSRF when page loads
  getCsrf();
</script>
</body>
</html>

